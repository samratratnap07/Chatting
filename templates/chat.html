<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nick & Saisha Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <div class="bg-blur-lights"></div>
    <header>Nick & Saisha Chat</header>

    <div class="chat-box" id="chat-box"></div>

    <form id="chat-form">
        <input type="text" id="message" placeholder="Type a message..." autocomplete="off" required>
        <button type="submit">Send</button>
    </form>

    <script>
        const chatBox = document.getElementById("chat-box");
        const form = document.getElementById("chat-form");
        const messageInput = document.getElementById("message");
        const username = "{{ username }}";

        function scrollToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function createMsgActions(msgDiv) {
            const actionsPopup = document.createElement("div");
            actionsPopup.className = "msg-actions";
            actionsPopup.innerHTML = `
                <button onclick="alert('Reply feature coming soon!')">Reply</button>
                <button onclick="alert('Forward feature coming soon!')">Forward</button>
                <button onclick="copyToClipboard('${msgDiv.querySelector('.bubble').innerText.replace(/'/g, "\\'")}')">Copy</button>
                <button onclick="alert('Delete feature coming soon!')">Delete</button>
                <button onclick="closeActions(this)">Close</button>
            `;
            msgDiv.appendChild(actionsPopup);
            return actionsPopup;
        }

        function closeActions(btn) {
            btn.parentNode.classList.remove('show');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            alert('Message copied!');
        }

        function loadMessages() {
            fetch("/messages")
                .then(res => res.json())
                .then(data => {
                    chatBox.innerHTML = "";
                    data.messages.forEach((msg) => {
                        let msgDiv = document.createElement("div");
                        msgDiv.classList.add("message");
                        msgDiv.classList.add(msg.sender === username ? "sent" : "received");

                        // Instagram style bubble
                        msgDiv.innerHTML = `
                            <div class="username">${msg.sender}</div>
                            <div class="bubble">${msg.message}</div>
                            <div class="timestamp">${msg.timestamp}</div>
                        `;

                        msgDiv.oncontextmenu = (e) => { e.preventDefault(); }
                        msgDiv.onmousedown = (e) => {
                            if (e.button === 0 || e.button === 2) {
                                msgDiv.longPressTimer = setTimeout(() => {
                                    document.querySelectorAll(".msg-actions.show").forEach(el => el.classList.remove("show"));
                                    let actions = msgDiv.querySelector(".msg-actions");
                                    if (!actions) actions = createMsgActions(msgDiv);
                                    actions.classList.add('show');
                                }, 370);
                            }
                        };
                        msgDiv.onmouseup = msgDiv.onmouseleave = () => {
                            if(msgDiv.longPressTimer) clearTimeout(msgDiv.longPressTimer);
                        };

                        chatBox.appendChild(msgDiv);
                    });
                    scrollToBottom();
                });
        }

        form.addEventListener("submit", e => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (!text) return;
            fetch("/send", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({message: text})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    messageInput.value = "";
                    loadMessages();
                }
            });
        });

        setInterval(loadMessages, 2000);
        loadMessages();
    </script>
</body>
</html>
