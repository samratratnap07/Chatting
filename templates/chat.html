<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nick & Saisha Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="bg-blur-lights"></div>
    <header>Nick & Saisha Chat</header>

    <div class="main-chat-layout">
        <div class="chat-box" id="chat-box"></div>

        <form id="chat-form">
            <input type="text" id="message" placeholder="Type a message..." autocomplete="off" required>
            <button type="submit">Send</button>
        </form>
    </div>

    <script>
        const chatBox = document.getElementById("chat-box");
        const form = document.getElementById("chat-form");
        const messageInput = document.getElementById("message");
        const username = "{{ username }}";

        function scrollToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function createMsgActions(msgDiv) {
            // Remove existing if any
            msgDiv.querySelectorAll('.msg-actions').forEach(el => el.remove());
            const actionsPopup = document.createElement("div");
            actionsPopup.className = "msg-actions";
            actionsPopup.innerHTML = `
                <button onclick="replyMsg('${msgDiv.querySelector('.bubble').innerText.replace(/'/g,"\\'")}')">Reply</button>
                <button onclick="forwardMsg('${msgDiv.querySelector('.bubble').innerText.replace(/'/g,"\\'")}')">Forward</button>
                <button onclick="copyToClipboard('${msgDiv.querySelector('.bubble').innerText.replace(/'/g,"\\'")}')">Copy</button>
                <button onclick="deleteMsg(this)">Delete</button>
                <button onclick="closeActions(this)">Close</button>
            `;
            msgDiv.appendChild(actionsPopup);
            setTimeout(()=>actionsPopup.classList.add('show'),20);
            // Close popup if click is anywhere outside
            window.onclick = function(event) {
                if (!msgDiv.contains(event.target)) {
                    actionsPopup.classList.remove('show');
                }
            };
            return actionsPopup;
        }

        function closeActions(btn) {
            btn.parentNode.classList.remove('show');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            alert('Message copied!');
        }
        function replyMsg(msg) {
            messageInput.value = "@" + msg + "\n";
            messageInput.focus();
            closeOptionsPopups();
        }
        function forwardMsg(msg) {
            alert('Forward feature coming soon!');
            closeOptionsPopups();
        }
        function deleteMsg(btn) {
            btn.parentNode.parentNode.remove(); // Only removes from DOM. Real delete needs backend.
        }
        function closeOptionsPopups(){
            document.querySelectorAll('.msg-actions.show').forEach(el=>el.classList.remove('show'));
        }

        function loadMessages() {
            fetch("/messages")
                .then(res => res.json())
                .then(data => {
                    chatBox.innerHTML = "";
                    data.messages.forEach((msg) => {
                        let msgDiv = document.createElement("div");
                        msgDiv.classList.add("message");
                        msgDiv.classList.add(msg.sender === username ? "sent" : "received");
                        msgDiv.innerHTML = `
                            <div class="username">${msg.sender}</div>
                            <div class="bubble">${msg.message}</div>
                            <div class="timestamp">${msg.timestamp}</div>
                        `;

                        // Enable single-click to open options instead of long-press
                        msgDiv.onclick = (e) => {
                            // Only trigger on non-popup button click
                            if(!e.target.classList.contains('bubble')) return;
                            closeOptionsPopups();
                            let actions = msgDiv.querySelector(".msg-actions");
                            if (!actions) actions = createMsgActions(msgDiv);
                            actions.classList.add('show');
                        };
                        chatBox.appendChild(msgDiv);
                    });
                    scrollToBottom();
                });
        }

        form.addEventListener("submit", e => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (!text) return;
            fetch("/send", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({message: text})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    messageInput.value = "";
                    loadMessages();
                }
            });
        });

        // Refresh messages every 2 seconds
        setInterval(loadMessages, 2000);
        loadMessages();
    </script>
</body>
</html>
